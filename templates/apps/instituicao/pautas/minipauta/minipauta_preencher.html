{% load static %}

<!DOCTYPE html>
<html lang="pt">
	<head>
		<meta charset="UTF-8" />
		<title>Preencher Mini Pauta</title>
		<link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}" />

		<link rel="stylesheet" href="{% static 'css/bootstrap-icons.css' %}" />
		<style>
			.is-valid {
				border-color: green;
			}
			.is-invalid {
				border-color: red;
			}
		</style>

		<style>
			input[type="number"] {
				width: 60px;
			}
			th,
			td {
				text-align: center;
			}
		</style>
	</head>
	<body class="container mt-4">
		<h3 class="mb-4 text-center">
			Preenchimento da Mini Pauta - {{ disciplina.nome }}
		</h3>


			<!---->
	<form method="POST">
		{% csrf_token %}
		<select name="turma">
			<option value="">-- Selecionar Turma --</option>
			{% for turma in turmas %}
			<option value="{{ turma.id }}">{{ turma.nome }}</option>
			{% endfor %}
		</select>

		<select name="disciplina">
			<option value="">-- Selecionar Disciplina --</option>
			{% for disciplina in disciplinas %}
			<option value="{{ disciplina.id }}">{{ disciplina.nome }}</option>
			{% endfor %}
		</select>

		<select name="trimestre">
			<option value="">-- Selecionar Trimestre --</option>
			<option value="1">1º Trimestre</option>
			<option value="2">2º Trimestre</option>
			<option value="3">3º Trimestre</option>
		</select>

		<button type="submit" name="filtrar">Filtrar</button>
	</form>

	<!---->


		<form method="post">
			{% csrf_token %}
			<table class="table table-bordered">
				<thead class="table-warning">
					<tr>
						<th>Nr</th>
						<th>Nome do Aluno</th>
						<th>AV1</th>
						<th>AV2</th>
						<th>AV3</th>
						<th>AV4</th>
						<th>MAC</th>
						<th>NPP</th>
						<th>NPT</th>
						<th>MT</th>
					</tr>
				</thead>
				<tbody>
					{% for aluno in alunos %}
					<tr>
						<td>{{ forloop.counter }}</td>
						<td>{{ aluno.nome }}</td>
						<td>
							<input
								type="number"
								step="0.1"
								name="av1_{{ aluno.id }}"
								class="nota av"
								oninput="calcularLinha({{ aluno.id }})"
							/>
						</td>
						<td>
							<input
								type="number"
								step="0.1"
								name="av2_{{ aluno.id }}"
								class="nota av"
								oninput="calcularLinha({{ aluno.id }})"
							/>
						</td>
						<td>
							<input
								type="number"
								step="0.1"
								name="av3_{{ aluno.id }}"
								class="nota av"
								oninput="calcularLinha({{ aluno.id }})"
							/>
						</td>
						<td>
							<input
								type="number"
								step="0.1"
								name="av4_{{ aluno.id }}"
								class="nota av"
								oninput="calcularLinha({{ aluno.id }})"
							/>
						</td>
						<td>
							<input
								type="number"
								name="mac_{{ aluno.id }}"
								class="nota mac"
								readonly
							/>
						</td>
						<td>
							<input
								type="number"
								step="0.1"
								name="npp_{{ aluno.id }}"
								class="nota npp"
								oninput="calcularLinha({{ aluno.id }})"
							/>
						</td>
						<td>
							<input
								type="number"
								step="0.1"
								name="npt_{{ aluno.id }}"
								class="nota npt"
								oninput="calcularLinha({{ aluno.id }})"
							/>
						</td>
						<td>
							<input
								type="number"
								name="mt_{{ aluno.id }}"
								class="nota mt"
								readonly
							/>
						</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>

			<div class="text-center">
				<button type="submit" class="btn btn-primary">Salvar Notas</button>
			</div>
		</form>

		<script>
			function calcularLinha(id) {
				const avs = [1, 2, 3, 4].map(
					(i) =>
						parseFloat(
							document.querySelector(`[name="av${i}_${id}"]`)?.value
						) || 0
				);

				const mac =
					avs.filter((n) => n > 0).reduce((a, b) => a + b, 0) /
					(avs.filter((n) => n > 0).length || 1);
				document.querySelector(`[name="mac_${id}"]`).value = mac.toFixed(1);

				const npp =
					parseFloat(document.querySelector(`[name="npp_${id}"]`)?.value) || 0;
				const npt =
					parseFloat(document.querySelector(`[name="npt_${id}"]`)?.value) || 0;

				const mt = (mac + npp + npt) / 3;
				document.querySelector(`[name="mt_${id}"]`).value = mt.toFixed(1);
			}
		</script>

		<!---->
		<!---->
		<!---->
		<script>
			function calcularLinha(id) {
				const avs = [1, 2, 3, 4].map(
					(i) =>
						parseFloat(
							document.querySelector(`[name="av${i}_${id}"]`)?.value
						) || 0
				);

				const mac =
					avs.filter((n) => n > 0).reduce((a, b) => a + b, 0) /
					(avs.filter((n) => n > 0).length || 1);
				const macField = document.querySelector(`[name="mac_${id}"]`);
				macField.value = mac.toFixed(1);

				const npp =
					parseFloat(document.querySelector(`[name="npp_${id}"]`)?.value) || 0;
				const npt =
					parseFloat(document.querySelector(`[name="npt_${id}"]`)?.value) || 0;

				const mt = (mac + npp + npt) / 3;
				const mtField = document.querySelector(`[name="mt_${id}"]`);
				mtField.value = mt.toFixed(1);

				// Validação visual
				validarCampo(macField);
				validarCampo(mtField);

				for (let i = 1; i <= 4; i++) {
					validarCampo(document.querySelector(`[name="av${i}_${id}"]`));
				}

				validarCampo(document.querySelector(`[name="npp_${id}"]`));
				validarCampo(document.querySelector(`[name="npt_${id}"]`));
			}

			function validarCampo(input) {
				const valor = parseFloat(input.value);
				if (!isNaN(valor) && valor >= 0 && valor <= 20) {
					input.classList.remove("is-invalid");
					input.classList.add("is-valid");
				} else {
					input.classList.remove("is-valid");
					input.classList.add("is-invalid");
				}
			}
		</script>

		<!---->
		<!---->
		<!---->
	</body>
</html>
