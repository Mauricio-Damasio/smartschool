{% load static %}
{% load custom_filters %}
<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>Mini Pauta</title>

    <!--::-BOOTSTRAP CSS-::-->
<link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}" />

<!--::-BOOTSTRAP ICON-::-->
<link
	rel="stylesheet"
	href="{% static 'icon/font/bootstrap-icons.min.css' %}"
/>

<style>

    /* Feedback visual na linha */
tr.salvo {
    background-color: #d4edda;
    transition: background-color 0.3s ease;
}

/* Loader girat√≥rio */
.loader {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #ccc;
    border-top: 3px solid #007bff;
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
}

@keyframes spin {
    0% { transform: translateY(-50%) rotate(0deg); }
    100% { transform: translateY(-50%) rotate(360deg); }
}

/* Alertas */
.alert-success, .alert-error {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 10px 20px;
    border-radius: 5px;
    color: #fff;
    z-index: 9999;
    font-weight: bold;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}

.alert-success {
    background-color: #28a745;
}

.alert-error {
    background-color: #dc3545;
}

</style>
    
</head>
<body>
    <h2>Preencher Mini Pauta</h2>

    <form method="get">
        <label>Turma:
            <select name="turma" onchange="this.form.submit()">
                <option value="">Selecione</option>
                {% for turma in turmas %}
                    <option value="{{ turma.id }}" {% if turma.id|stringformat:"s" == turma_id %}selected{% endif %}>{{ turma.nome }}</option>
                {% endfor %}
            </select>
        </label>

        <label>Disciplina:
            <select name="disciplina" onchange="this.form.submit()">
                <option value="">Selecione</option>
                {% for disc in disciplinas %}
                    <option value="{{ disc.id }}" {% if disc.id|stringformat:"s" == disciplina_id %}selected{% endif %}>{{ disc.nome }}</option>
                {% endfor %}
            </select>
        </label>

        <label>Trimestre:
            <select name="trimestre" onchange="this.form.submit()">
                <option value="">Selecione</option>
                {% for trimestre_nome in trimestres %}
                    <option value="{{ forloop.counter }}" {% if forloop.counter|stringformat:"s" == trimestre %}selected{% endif %}>
                        {{ trimestre_nome }}
                    </option>
                {% endfor %}
            </select>
        </label>
    </form>

    {% if alunos %}
    <table border="1">
        <thead>
            <tr>
                <th>Aluno</th>
                <th>AV1</th><th>AV2</th><th>AV3</th><th>AV4</th><th>MAC</th>
                <th>NPP</th><th>NPT</th><th>MT</th><th>Exame</th><th>MF</th>
            </tr>
        </thead>
        <tbody>
            {% for aluno in alunos %}
                {% with pauta=pauta_dict|get_item:aluno.id %}
                <tr>
                    <td>{{ aluno.nome }}</td>
                    <td><input type="number" step="0.1" class="nota" name="av1" data-id="{{ aluno.id }}" value="{{ pauta.av1|default:0 }}"></td>
                    <td><input type="number" step="0.1" class="nota" name="av2" data-id="{{ aluno.id }}" value="{{ pauta.av2|default:0 }}"></td>
                    <td><input type="number" step="0.1" class="nota" name="av3" data-id="{{ aluno.id }}" value="{{ pauta.av3|default:0 }}"></td>
                    <td><input type="number" step="0.1" class="nota" name="av4" data-id="{{ aluno.id }}" value="{{ pauta.av4|default:0 }}"></td>
                    <td><input type="number" step="0.1" name="mac" readonly data-id="{{ aluno.id }}"></td>
                    <td><input type="number" step="0.1" name="npp" data-id="{{ aluno.id }}"></td>
                    <td><input type="number" step="0.1" name="npt" data-id="{{ aluno.id }}"></td>
                    <td><input type="number" step="0.1" name="mt" readonly data-id="{{ aluno.id }}"></td>
                    <td><input type="number" step="0.1" name="exame" data-id="{{ aluno.id }}"></td>
                    <td><input type="number" step="0.1" name="mf" readonly data-id="{{ aluno.id }}"></td>
                </tr>
                {% endwith %}
            {% endfor %}
            </tbody>
            
    </table>
    {% endif %}


    <!---->
    <!---->
     <!---->
     <script>
        document.addEventListener("DOMContentLoaded", () => {
            document.querySelectorAll(".nota").forEach((input) => {
                input.addEventListener("input", calcularLinha);
            });
        });
        
        function calcularLinha(e) {
            const row = e.target.closest("tr");
            const alunoId = e.target.dataset.id;
            const inputs = row.querySelectorAll("input");
        
            const av1 = parseFloat(inputs[0].value) || 0;
            const av2 = parseFloat(inputs[1].value) || 0;
            const av3 = parseFloat(inputs[2].value) || 0;
            const av4 = parseFloat(inputs[3].value) || 0;
        
            const mac = ((av1 + av2 + av3 + av4) / 4).toFixed(1);
            inputs[4].value = mac;
        
            const npp = parseFloat(inputs[5].value) || 0;
            const npt = parseFloat(inputs[6].value) || 0;
        
            const mt = (parseFloat(mac) * 0.4 + npp * 0.2 + npt * 0.4).toFixed(1);
            inputs[7].value = mt;
        
            const exame = parseFloat(inputs[8].value) || 0;
            const mf = ((parseFloat(mt) + exame) / 2).toFixed(1);
            inputs[9].value = mf;
        
            const data = {
                aluno_id: alunoId,
                disciplina_id: getParam("disciplina"),
                trimestre: getParam("trimestre"),
                av1,
                av2,
                av3,
                av4,
                mac,
                npp,
                npt,
                mt,
                exame,
                mf,
            };
        
            const turmaId = getParam("turma");
          /*  const url = `/pauta/salvar_mini_pauta/?turma=${turmaId}`;*/
          console.log("turmaId ===========", turmaId);

        
            mostrarLoading(row);
        
            fetch(`{% url 'school:mini_pauta_salvar' %}?turma=${turmaId}`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie("csrftoken"),
                },
                body: JSON.stringify(data),
            })
            .then(response => {
                removerLoading(row);
                if (response.ok) {
                    mostrarFeedbackSucesso(row);
                    showMessage("Notas salvas com sucesso!", "success");
                } else {
                    showMessage("Erro ao salvar notas.", "error");
                    console.error("Erro HTTP:", response.status);
                }
            })
            .catch(error => {
                removerLoading(row);
                showMessage("Erro de rede ao salvar notas.", "error");
                console.error("Erro de rede:", error);
            });
        }
        
        function mostrarLoading(row) {
            let loader = row.querySelector(".loader");
            if (!loader) {
                loader = document.createElement("div");
                loader.className = "loader";
                row.appendChild(loader);
            }
            loader.style.display = "inline-block";
        }
        
        function removerLoading(row) {
            const loader = row.querySelector(".loader");
            if (loader) {
                loader.style.display = "none";
            }
        }
        
        function mostrarFeedbackSucesso(row) {
            row.classList.add("salvo");
            setTimeout(() => row.classList.remove("salvo"), 1500);
        }
        
        function getParam(name) {
            const url = new URL(window.location.href);
            return url.searchParams.get(name);
        }
        
        function getCookie(name) {
            let cookie = document.cookie
                .split(";")
                .find((c) => c.trim().startsWith(name + "="));
            return cookie ? decodeURIComponent(cookie.split("=")[1]) : null;
        }
        
        function showMessage(texto, tipo) {
            const msgBox = document.createElement("div");
            msgBox.className = tipo === "success" ? "alert-success" : "alert-error";
            msgBox.innerText = texto;
        
            document.body.appendChild(msgBox);
        
            setTimeout(() => {
                msgBox.remove();
            }, 3000);
        }
        
        </script>
        
   

    <!---->
</body>
</html>